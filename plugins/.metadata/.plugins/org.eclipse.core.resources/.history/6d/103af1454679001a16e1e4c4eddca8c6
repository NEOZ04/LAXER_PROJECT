<?php 

namespace laxer;

use laxer\player\PlayerListener;
use laxer\phone\PhoneListener;
use pocketmine\event\Listener;
use pocketmine\event\player\PlayerJoinEvent;
use laxer\ui\CoreUI;
use pocketmine\event\player\PlayerQuitEvent;
use pocketmine\event\player\PlayerItemHeldEvent;
use laxer\shop\ShopListener;
use laxer\crate\CrateListener;
use laxer\pshop\PShopListener;
use pocketmine\event\entity\EntityLevelChangeEvent;
use pocketmine\Player;

class CoreListeners implements Listener {
    
    public function registerAll(Core $core){
        $listeners = [
            new PlayerListener(), new PhoneListener(), $this, new ShopListener(), new CrateListener(),
            new PShopListener()
            
        ];
        foreach ($listeners as $listener){
            $core->getServer()->getPluginManager()->registerEvents($listener, $core);
        }
    }
    
    public function onJoin(PlayerJoinEvent $e){
        Core::getInstance()->getCrate()->loadCrates();
        $p = $e->getPlayer();
        $p->setAllowFlight(false);
        $p->setFlying(false);
        $e->setJoinMessage(CoreUI::Notice($p->getName().' join game'));
        $p->teleport(Core::getInstance()->getServer()->getDefaultLevel()->getSafeSpawn());
    }
    
    public function onChangeWorld(EntityLevelChangeEvent $e){
        $p = $e->getEntity();
        if ($p instanceof Player){
            $p->setFlying(false);
            $p->setAllowFlight(false);
        }
    }
    
    public function onLeft(PlayerQuitEvent $e){
        $p = $e->getPlayer();
        $e->setQuitMessage(CoreUI::Warning($p->getName().' left game'));
    }
    
    public function onChangeItem(PlayerItemHeldEvent $e){
        $p = $e->getPlayer();
        $i = $e->getItem();
        $p->sendPopup($i->getName().' '.$i->getId().':'.$i->getDamage());
    }
    
}