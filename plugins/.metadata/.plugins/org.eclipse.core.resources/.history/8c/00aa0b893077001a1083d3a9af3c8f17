<?php 

namespace laxer\pshop;

use pocketmine\Player;
use laxer\ui\CoreUI;
use laxer\Core;
use pocketmine\utils\TextFormat;

class PShopUI {
    
    private $p;
    private $shop;
    private $data = [];
    
    private function getButtons(){
        $p = $this->p;
        $btns = [];
        if ($this->getShop()->isOwner($p)) {
            $btns = [
                "Profil", "Set Name", "Items Price", "Helpers", "Set Chest", "Set Sign"
            ];
        }elseif ($this->shop->isHelper($p->getName())){
            $btns = [
                "Profil", "Items Price", "Helpers", "Set Chest", "Set Sign"
            ];
        }
        return $btns;
    }
    
    public function getShop(){
        $p = $this->p;
        $shop = $this->shop;
        if (is_null($shop)) {
            $shop = Core::getInstance()->getPShop()->getShop($p->getName());
        }
        return $shop;
    }
    
    public function getMainForm(Player $p, Shop $shop = null){
        $this->p = $p;
        $this->shop = $shop;
        $ui = CoreUI::Simple(function (Player $p, $data){
            if ($data === null) return true;
            $btn = $this->getButtons()[$data];
            switch (strtolower($btn)){
                case "profil":
                    $this->Profil($p);
                    break;
                case "items price":
                    $this->ItemsPrice($p);
                    break;
                case "helpers":
                    break;
                case "set chest":
                    Core::$_SESSIONS[$p->getName()]['setChest'] = [
                        'time' => time(),
                        'shop' => $this->getShop()
                    ];
                    $p->sendMessage(CoreUI::Notice('Tap chest'));
                    break;
                case "set sign":
                    break;
                case "set name":
                    $this->SetName($p);
                    break;
            }
        });
        $ui->setTitle(CoreUI::fTitle('PSHOP'));
        foreach ($this->getButtons() as $text){
            $ui->addButton(CoreUI::fButton($text));
        }
        $ui->sendToPlayer($p);
    }
    
    public function Profil(Player $p){
        $ui = CoreUI::Custom(function (Player $p, $data){
            if ($data === null) return true;
        });
        $ui->setTitle(CoreUI::fTitle('PSHOP'));
        $shop = $this->getShop();
        $data = [
            "Nama" => $shop->getName(),
            "Owner" => $shop->getOwner()->getName(),
            "Point" => $shop->getPoint(),
            "Max Helper" => $shop->getMaxHelper(),
            "Max Chest" => $shop->getMaxChest(),
        ];
        foreach ($data as $k => $v){
            $ui->addLabel(TextFormat::colorize('&l&f•> '.$k.': &r&7'.$v));
        }
        $ui->sendToPlayer($p);
    }
    
    public function SetName(Player $p){
        $ui = CoreUI::Custom(function (Player $p, $data){
            if ($data === null) return true;
            $name = $data[0];
            if ($name === $this->getShop()->getName()) {
                return false;
            }
            $pm = Core::getInstance()->getMoneyAPI();
            $owner = $this->getShop()->getOwner();
            $money = $pm->getMoney($owner->getName());
            $price = (int) Core::getInstance()->getConfig()->get('pshop-setname-price');
            var_dump($price);
            if ($money >= $price || $this->getShop()->getName() == $p->getName()){
                $this->getShop()->setName($name);
                $p->sendMessage(CoreUI::Success('Anda berhasil mengubah nama shop anda menjadi '.$name));
                if ($this->getShop()->getName() != $p->getName()) {
                    $pm->reduceMoney($p->getName(), $price);
                }
            }else {
                $p->sendMessage(CoreUI::Danger('Uang anda tidak cukup untuk mengubah nama seharga '.$price));
            }
        });
            $ui->setTitle(CoreUI::fTitle('PSHOP'));
            $shop = $this->getShop();
            $ui->addInput(TextFormat::colorize('&l&f•> New Name'), $shop->getName());
            $ui->sendToPlayer($p);
    }
    
    public function ItemsPrice(Player $p){
        $ui = CoreUI::Simple(function (Player $p, $data){
            if ($data === null) return true;
            $items = $this->getShop()->getAllItems();
            if (!empty($items)) {
                $item = $items[$data];
                $this->data['item'] = $item;
                $this->setPrice($p);
            }
        });
        $ui->setTitle(CoreUI::fTitle('PSHOP'));
        $items = $this->getShop()->getAllItems();
        if (!empty($items)){
            foreach ($items as $item_name){
                $price = $this->getShop()->getPrice($item_name);
                $ui->addButton(CoreUI::fButton($item_name.": &r".$price));
            }
        }else {
            $ui->addButton(CoreUI::fBButton('KELUAR'));
        }
        $ui->sendToPlayer($p);
    }
    
    public function setPrice(Player $p){
        $ui = CoreUI::Custom(function (Player $p, $data){
            if ($data === null) return true;
            $price = $data[0];
            $name = $this->data['item'];
            if (!is_numeric($price)){
                $p->sendMessage(CoreUI::Danger('Inputan harus berupa angka'));
                return false;
            }
            $this->getShop()->setPrice((int)$price);
            $p->sendMessage(CoreUI::Success('Harga '.$name.' berhasil di ubah menjadi '.$price));
        });
            $ui->setTitle(CoreUI::fTitle('PSHOP'));
            $shop = $this->getShop();
            $ui->addInput(TextFormat::colorize('&l&f•> Price'), $shop->getPrice($this->data['item']));
            $ui->sendToPlayer($p);
    }
}